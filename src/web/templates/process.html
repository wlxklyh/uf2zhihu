{% extends "base.html" %}

{% block title %}å¤„ç†ä¸­ - YouTubeè½¬æ–‡ç« å·¥å…·{% endblock %}

{% block extra_css %}
<style>
.step-progress {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2rem;
}

.step-progress .step {
    flex: 1;
    text-align: center;
    position: relative;
}

.step-progress .step:not(:last-child):after {
    content: '';
    position: absolute;
    top: 20px;
    left: 50%;
    width: 100%;
    height: 2px;
    background: #e9ecef;
    z-index: 1;
}

.step-progress .step.completed:not(:last-child):after {
    background: #28a745;
}

.step-progress .step.active:not(:last-child):after {
    background: linear-gradient(to right, #28a745 50%, #e9ecef 50%);
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e9ecef;
    color: #6c757d;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 0.5rem;
    position: relative;
    z-index: 2;
}

.step.active .step-number {
    background: #007bff;
    color: white;
}

.step.completed .step-number {
    background: #28a745;
    color: white;
}

.step.error .step-number {
    background: #dc3545;
    color: white;
}

.log-output {
    background: #1e1e1e;
    color: #f8f9fa;
    border-radius: 0.375rem;
    padding: 1rem;
    height: 400px;
    overflow-y: auto;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.875rem;
    line-height: 1.4;
}

.log-entry {
    margin-bottom: 0.25rem;
    padding: 0.25rem 0;
}

.log-entry.info { color: #17a2b8; }
.log-entry.success { color: #28a745; }
.log-entry.warning { color: #ffc107; }
.log-entry.error { color: #dc3545; }

.file-list {
    max-height: 300px;
    overflow-y: auto;
}

.file-item {
    padding: 0.5rem;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 0.5rem;
    background: #f8f9fa;
}

.file-item:hover {
    background: #e9ecef;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-0">
                <i class="fas fa-cogs me-2"></i>
                å¤„ç†è¿›åº¦
            </h2>
            <p class="text-muted">é¡¹ç›®ï¼š{{ project_name }}</p>
        </div>
    </div>

    <!-- æ­¥éª¤è¿›åº¦æ¡ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="step-progress">
                        <div class="step active" id="step1">
                            <div class="step-number">1</div>
                            <small>ä¸‹è½½è§†é¢‘</small>
                        </div>
                        <div class="step" id="step2">
                            <div class="step-number">2</div>
                            <small>è¯­éŸ³è½¬å½•</small>
                        </div>
                        <div class="step" id="step3">
                            <div class="step-number">3</div>
                            <small>æå–æˆªå›¾</small>
                        </div>
                        <div class="step" id="step4">
                            <div class="step-number">4</div>
                            <small>ç”Ÿæˆæ–‡ç« </small>
                        </div>
                        <div class="step" id="step5">
                            <div class="step-number">5</div>
                            <small>ç”ŸæˆPrompt</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="row">
        <!-- å·¦ä¾§ï¼šå½“å‰æ­¥éª¤è¯¦æƒ… -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0" id="currentStepTitle">
                        <i class="fas fa-download me-2"></i>
                        æ­¥éª¤1ï¼šä¸‹è½½YouTubeè§†é¢‘
                    </h5>
                </div>
                <div class="card-body">
                    <!-- ä¸‹è½½è¿›åº¦è¯¦æƒ…ï¼ˆä»…æ­¥éª¤1æ˜¾ç¤ºï¼‰ -->
                    <div id="downloadProgressContainer" style="display: none;" class="mb-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    <i class="fas fa-download me-2"></i>
                                    ä¸‹è½½è¿›åº¦
                                </h6>
                                
                                <!-- è¿›åº¦æ¡ -->
                                <div class="progress mb-3" style="height: 25px;">
                                    <div id="downloadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%;" 
                                         aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                        <span id="downloadPercent">0%</span>
                                    </div>
                                </div>
                                
                                <!-- è¯¦ç»†ä¿¡æ¯ -->
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <small class="text-muted">ä¸‹è½½é€Ÿåº¦</small>
                                        <div id="downloadSpeed" class="fw-bold">-- MB/s</div>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">å·²ä¸‹è½½</small>
                                        <div id="downloadDownloaded" class="fw-bold">-- MB</div>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">æ€»å¤§å°</small>
                                        <div id="downloadTotal" class="fw-bold">-- MB</div>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">é¢„è®¡å‰©ä½™</small>
                                        <div id="downloadETA" class="fw-bold">--</div>
                                    </div>
                                </div>
                                
                                <!-- è¶…æ—¶è­¦å‘Š -->
                                <div id="timeoutWarning" class="alert alert-warning mt-3" style="display: none;">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <span id="timeoutWarningText"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è½¬å½•è¿›åº¦è¯¦æƒ…ï¼ˆä»…æ­¥éª¤2æ˜¾ç¤ºï¼‰ -->
                    <div id="transcribeProgressContainer" style="display: none;" class="mb-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    <i class="fas fa-microphone me-2"></i>
                                    è½¬å½•è¿›åº¦
                                </h6>
                                
                                <!-- è¿›åº¦æ¡ -->
                                <div class="progress mb-3" style="height: 25px;">
                                    <div id="transcribeProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                                         role="progressbar" style="width: 0%;" 
                                         aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                        <span id="transcribePercent">0%</span>
                                    </div>
                                </div>
                                
                                <!-- è¯¦ç»†ä¿¡æ¯ -->
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <small class="text-muted">è½¬å½•é€Ÿåº¦</small>
                                        <div id="transcribeSpeed" class="fw-bold">--</div>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">å·²ç”¨æ—¶é—´</small>
                                        <div id="transcribeElapsed" class="fw-bold">--</div>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">é¢„è®¡å‰©ä½™</small>
                                        <div id="transcribeETA" class="fw-bold">--</div>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">è¿›åº¦</small>
                                        <div id="transcribeProgress" class="fw-bold">--</div>
                                    </div>
                                </div>
                                
                                <!-- æ¨¡å‹ä¿¡æ¯ -->
                                <div class="mt-3 p-2 bg-white rounded">
                                    <div class="row text-center">
                                        <div class="col-md-6">
                                            <small class="text-muted">ä½¿ç”¨æ¨¡å‹</small>
                                            <div id="transcribeModel" class="fw-bold text-primary">--</div>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted">ç›®æ ‡è¯­è¨€</small>
                                            <div id="transcribeLanguage" class="fw-bold text-primary">--</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ—¥å¿—æ§åˆ¶å·¥å…·æ  -->
                    <div class="log-controls mb-2 d-flex gap-2 align-items-center">
                        <!-- å·¦ä¾§ï¼šç­›é€‰å’Œæœç´¢ -->
                        <select class="form-select form-select-sm" id="logLevelFilter" style="width: auto;">
                            <option value="all">å…¨éƒ¨æ—¥å¿—</option>
                            <option value="info">ä¿¡æ¯</option>
                            <option value="success">æˆåŠŸ</option>
                            <option value="warning">è­¦å‘Š</option>
                            <option value="error">é”™è¯¯</option>
                        </select>
                        
                        <input type="text" class="form-control form-control-sm" 
                               id="logSearch" placeholder="æœç´¢æ—¥å¿—..." style="max-width: 200px;">
                        
                        <!-- å³ä¾§ï¼šæ“ä½œæŒ‰é’® -->
                        <div class="ms-auto d-flex gap-1">
                            <button class="btn btn-sm btn-outline-secondary" id="copyLogsBtn" title="å¤åˆ¶æ—¥å¿—">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="exportLogsBtn" title="å¯¼å‡ºæ—¥å¿—">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="clearLogsBtn" title="æ¸…ç©ºæ˜¾ç¤º">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary active" id="toggleAutoScrollBtn" title="è‡ªåŠ¨æ»šåŠ¨">
                                <i class="fas fa-arrows-alt-v"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- å®æ—¶æ—¥å¿—è¾“å‡º -->
                    <div class="log-output" id="logOutput">
                        <div class="log-entry info">æ­£åœ¨åˆå§‹åŒ–å¤„ç†æµç¨‹...</div>
                        <div class="log-entry info">é¡¹ç›®åç§°: {{ project_name }}</div>
                        <div class="log-entry info">YouTubeé“¾æ¥: {{ youtube_url }}</div>
                        <div class="log-entry info">å‡†å¤‡å¼€å§‹å¤„ç†...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šæ§åˆ¶é¢æ¿å’Œè¾“å‡ºæ–‡ä»¶ -->
        <div class="col-lg-4">
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-gamepad me-2"></i>
                        æ§åˆ¶é¢æ¿
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-warning" id="pauseBtn" disabled>
                            <i class="fas fa-pause me-2"></i>æš‚åœ
                        </button>
                        <button class="btn btn-info" id="retryBtn" disabled>
                            <i class="fas fa-redo me-2"></i>é‡è¯•å½“å‰æ­¥éª¤
                        </button>
                        <button class="btn btn-secondary" id="skipBtn" disabled>
                            <i class="fas fa-forward me-2"></i>è·³è¿‡å½“å‰æ­¥éª¤
                        </button>
                    </div>
                    
                    <!-- æ­¥éª¤æ§åˆ¶å™¨ -->
                    <div class="mt-3 pt-3 border-top" id="stepControlPanel">
                        <h6 class="mb-2">
                            <i class="fas fa-cogs me-1"></i>æ­¥éª¤æ§åˆ¶
                        </h6>
                        
                        <div class="mb-2">
                            <label class="form-label small mb-1">ä»æŒ‡å®šæ­¥éª¤é‡æ–°å¼€å§‹</label>
                            <select class="form-select form-select-sm mb-2" id="retryFromStep">
                                <option value="1">æ­¥éª¤1: ä¸‹è½½è§†é¢‘</option>
                                <option value="2">æ­¥éª¤2: è¯­éŸ³è½¬å½•</option>
                                <option value="3">æ­¥éª¤3: æå–æˆªå›¾</option>
                                <option value="4">æ­¥éª¤4: ç”Ÿæˆæ–‡ç« </option>
                                <option value="5">æ­¥éª¤5: ç”ŸæˆPrompt</option>
                            </select>
                            <button class="btn btn-sm btn-primary w-100" id="retryFromStepBtn" disabled>
                                <i class="fas fa-redo me-1"></i>ä»æ­¤æ­¥éª¤å¼€å§‹
                            </button>
                        </div>
                        
                        <div class="mt-3 p-2 bg-light rounded" id="stepTiming">
                            <small class="text-muted d-block">
                                <i class="fas fa-clock me-1"></i>å·²ç”¨æ—¶é—´: <strong id="elapsedTime">00:00</strong>
                            </small>
                            <small class="text-muted d-block mt-1">
                                <i class="fas fa-hourglass-half me-1"></i>é¢„è®¡å‰©ä½™: <strong id="estimatedTime">è®¡ç®—ä¸­...</strong>
                            </small>
                        </div>
                    </div>
                    
                    <!-- äººå·¥ç¡®è®¤å¯¹è¯æ¡† -->
                    <div id="confirmationPanel" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <strong>éœ€è¦ç¡®è®¤ï¼š</strong>
                            <p id="confirmationMessage" class="mb-2"></p>
                            <div class="d-grid gap-2">
                                <button class="btn btn-success btn-sm" id="confirmYes">
                                    <i class="fas fa-check me-1"></i>ç¡®è®¤ç»§ç»­
                                </button>
                                <button class="btn btn-danger btn-sm" id="confirmNo">
                                    <i class="fas fa-times me-1"></i>é‡æ–°å¤„ç†
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è¾“å‡ºæ–‡ä»¶é¢„è§ˆ -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-folder-open me-2"></i>
                        è¾“å‡ºæ–‡ä»¶
                    </h6>
                </div>
                <div class="card-body" id="outputFiles">
                    <p class="text-muted text-center">å¤„ç†å®Œæˆåæ˜¾ç¤ºè¾“å‡ºæ–‡ä»¶</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ–‡ä»¶é¢„è§ˆæ¨¡æ€æ¡† -->
<div class="modal fade" id="filePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-alt me-2"></i>
                    æ–‡ä»¶é¢„è§ˆ: <span id="previewFileName" class="text-primary"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="previewContent" class="file-preview" style="max-height: 600px; overflow-y: auto;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" onclick="copyPreviewContent()">
                    <i class="fas fa-copy me-1"></i>å¤åˆ¶å†…å®¹
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// å¤åˆ¶é¢„è§ˆå†…å®¹
function copyPreviewContent() {
    const content = document.getElementById('previewContent').textContent;
    navigator.clipboard.writeText(content).then(() => {
        showAlert('å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }).catch(err => {
        showAlert('å¤åˆ¶å¤±è´¥: ' + err, 'danger');
    });
}
</script>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
// åˆå§‹åŒ–Socket.IOè¿æ¥
const socket = io();

// é¡µé¢åŠ è½½æ—¶è·å–å‚æ•°
const urlParams = new URLSearchParams(window.location.search);
const projectName = urlParams.get('project') || '{{ project_name }}';
const youtubeUrl = urlParams.get('url') || '{{ youtube_url }}';

// å½“å‰æ­¥éª¤çŠ¶æ€
let currentStep = 1;
let isProcessing = true;

// Socket.IOäº‹ä»¶å¤„ç†
socket.on('connect', function() {
    console.log('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
    addLogEntry('å·²è¿æ¥åˆ°æœåŠ¡å™¨', 'success');
    
    // åŠ å…¥é¡¹ç›®æˆ¿é—´
    socket.emit('join_project', {project_name: projectName});
});

socket.on('joined_project', function(data) {
    addLogEntry('å·²åŠ å…¥é¡¹ç›®: ' + data.project_name, 'info');
});

socket.on('progress_update', function(data) {
    if (data.project_name === projectName) {
        addLogEntry(data.message, 'info');
        updateStepProgress(data.step, data.progress);
    }
});

socket.on('step_complete', function(data) {
    if (data.project_name === projectName) {
        const status = data.success ? 'success' : 'error';
        addLogEntry(data.message, status);
        
        if (data.success) {
            markStepCompleted(data.step);
            if (data.step < 6) {
                setActiveStep(data.step + 1);
            } else {
                // æ‰€æœ‰æ­¥éª¤å®Œæˆï¼Œè·³è½¬åˆ°ç»“æœé¡µé¢
                setTimeout(() => {
                    window.location.href = `/results/${projectName}`;
                }, 2000);
            }
        } else {
            markStepError(data.step);
            showConfirmation('æ­¥éª¤å¤±è´¥ï¼Œæ˜¯å¦é‡è¯•ï¼Ÿ');
        }
        
        // æ›´æ–°è¾“å‡ºæ–‡ä»¶åˆ—è¡¨
        updateOutputFiles(data.step);
    }
});

// å¤„ç†ä¸‹è½½è¿›åº¦æ›´æ–°
socket.on('download_progress', function(data) {
    console.log('ğŸ“Š æ”¶åˆ°ä¸‹è½½è¿›åº¦äº‹ä»¶:', data);
    if (data.project_name === projectName && data.step === 1) {
        console.log('âœ… é¡¹ç›®åŒ¹é…ï¼Œæ›´æ–°è¿›åº¦:', data.progress_data);
        updateDownloadProgress(data.progress_data);
    } else {
        console.log('âš ï¸ é¡¹ç›®ä¸åŒ¹é…æˆ–æ­¥éª¤ä¸æ˜¯1:', {
            receivedProject: data.project_name,
            currentProject: projectName,
            step: data.step
        });
    }
});

// å¤„ç†è½¬å½•è¿›åº¦æ›´æ–°
socket.on('transcribe_progress', function(data) {
    console.log('ğŸ“Š æ”¶åˆ°è½¬å½•è¿›åº¦äº‹ä»¶:', data);
    if (data.project_name === projectName && data.step === 2) {
        console.log('âœ… é¡¹ç›®åŒ¹é…ï¼Œæ›´æ–°è½¬å½•è¿›åº¦:', data.progress_data);
        updateTranscribeProgress(data.progress_data);
    } else {
        console.log('âš ï¸ é¡¹ç›®ä¸åŒ¹é…æˆ–æ­¥éª¤ä¸æ˜¯2:', {
            receivedProject: data.project_name,
            currentProject: projectName,
            step: data.step
        });
    }
});

// æ›´æ–°ä¸‹è½½è¿›åº¦æ˜¾ç¤º
function updateDownloadProgress(progressData) {
    console.log('ğŸ”„ æ›´æ–°ä¸‹è½½è¿›åº¦æ˜¾ç¤º:', progressData);
    
    const container = document.getElementById('downloadProgressContainer');
    const progressBar = document.getElementById('downloadProgressBar');
    const percent = document.getElementById('downloadPercent');
    const speed = document.getElementById('downloadSpeed');
    const downloaded = document.getElementById('downloadDownloaded');
    const total = document.getElementById('downloadTotal');
    const eta = document.getElementById('downloadETA');
    
    // æ˜¾ç¤ºå®¹å™¨
    if (container.style.display === 'none') {
        console.log('ğŸ‘ï¸ æ˜¾ç¤ºä¸‹è½½è¿›åº¦å®¹å™¨');
        container.style.display = 'block';
    }
    
    // æ›´æ–°è¿›åº¦æ¡
    const percentValue = progressData.percent || 0;
    progressBar.style.width = percentValue + '%';
    progressBar.setAttribute('aria-valuenow', percentValue);
    percent.textContent = percentValue.toFixed(1) + '%';
    
    // æ›´æ–°è¯¦ç»†ä¿¡æ¯
    speed.textContent = progressData.speed || '-- MB/s';
    downloaded.textContent = progressData.downloaded || '-- MB';
    total.textContent = progressData.total || '-- MB';
    eta.textContent = progressData.eta || '--';
    
    // æ£€æŸ¥è¶…æ—¶è­¦å‘Š
    if (progressData.timeout_warning) {
        showTimeoutWarning(progressData.timeout_warning);
    }
}

// æ˜¾ç¤ºè¶…æ—¶è­¦å‘Š
function showTimeoutWarning(message) {
    const warning = document.getElementById('timeoutWarning');
    const warningText = document.getElementById('timeoutWarningText');
    
    warningText.textContent = message;
    warning.style.display = 'block';
}

// æ›´æ–°è½¬å½•è¿›åº¦æ˜¾ç¤º
function updateTranscribeProgress(progressData) {
    console.log('ğŸ”„ æ›´æ–°è½¬å½•è¿›åº¦æ˜¾ç¤º:', progressData);
    
    const container = document.getElementById('transcribeProgressContainer');
    const progressBar = document.getElementById('transcribeProgressBar');
    const percent = document.getElementById('transcribePercent');
    const speed = document.getElementById('transcribeSpeed');
    const elapsed = document.getElementById('transcribeElapsed');
    const eta = document.getElementById('transcribeETA');
    const progress = document.getElementById('transcribeProgress');
    const model = document.getElementById('transcribeModel');
    const language = document.getElementById('transcribeLanguage');
    
    // æ˜¾ç¤ºå®¹å™¨
    if (container.style.display === 'none') {
        console.log('ğŸ‘ï¸ æ˜¾ç¤ºè½¬å½•è¿›åº¦å®¹å™¨');
        container.style.display = 'block';
    }
    
    // æ›´æ–°è¿›åº¦æ¡
    const percentValue = progressData.percent || 0;
    progressBar.style.width = percentValue + '%';
    progressBar.setAttribute('aria-valuenow', percentValue);
    percent.textContent = percentValue.toFixed(1) + '%';
    
    // æ›´æ–°è¯¦ç»†ä¿¡æ¯
    speed.textContent = progressData.speed || '--';
    elapsed.textContent = progressData.elapsed || '--';
    eta.textContent = progressData.eta || '--';
    progress.textContent = `${progressData.processed || '--'} / ${progressData.total || '--'}`;
    
    // æ›´æ–°æ¨¡å‹ä¿¡æ¯
    if (progressData.model) {
        model.textContent = progressData.model.toUpperCase();
    }
    if (progressData.language) {
        language.textContent = progressData.language.toUpperCase();
    }
}

// æ·»åŠ æ—¥å¿—æ¡ç›®
function addLogEntry(message, type = 'info') {
    const logOutput = document.getElementById('logOutput');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry ${type}`;
    logEntry.textContent = `[${timestamp}] ${message}`;
    
    logOutput.appendChild(logEntry);
    logOutput.scrollTop = logOutput.scrollHeight;
}

// æ›´æ–°æ­¥éª¤è¿›åº¦
function updateStepProgress(step, progress) {
    // è¿™é‡Œå¯ä»¥æ·»åŠ è¿›åº¦æ¡æ›´æ–°é€»è¾‘
    console.log(`æ­¥éª¤ ${step} è¿›åº¦: ${progress}%`);
}

// è®¾ç½®å½“å‰æ´»åŠ¨æ­¥éª¤
function setActiveStep(step) {
    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    
    // è®¾ç½®æ–°çš„æ´»åŠ¨æ­¥éª¤
    const stepElement = document.getElementById(`step${step}`);
    if (stepElement) {
        stepElement.classList.add('active');
        currentStep = step;
        
        // æ›´æ–°æ­¥éª¤æ ‡é¢˜
        updateStepTitle(step);
        
        // æ§åˆ¶ä¸‹è½½è¿›åº¦æ˜¾ç¤º
        const downloadContainer = document.getElementById('downloadProgressContainer');
        if (downloadContainer) {
            downloadContainer.style.display = (step === 1) ? 'block' : 'none';
        }
        
        // æ§åˆ¶è½¬å½•è¿›åº¦æ˜¾ç¤º
        const transcribeContainer = document.getElementById('transcribeProgressContainer');
        if (transcribeContainer) {
            transcribeContainer.style.display = (step === 2) ? 'block' : 'none';
        }
    }
}

// æ ‡è®°æ­¥éª¤å®Œæˆ
function markStepCompleted(step) {
    const stepElement = document.getElementById(`step${step}`);
    if (stepElement) {
        stepElement.classList.remove('active');
        stepElement.classList.add('completed');
    }
}

// æ ‡è®°æ­¥éª¤é”™è¯¯
function markStepError(step) {
    const stepElement = document.getElementById(`step${step}`);
    if (stepElement) {
        stepElement.classList.remove('active');
        stepElement.classList.add('error');
    }
}

// æ›´æ–°æ­¥éª¤æ ‡é¢˜
function updateStepTitle(step) {
    const titles = {
        1: '<i class="fas fa-download me-2"></i>æ­¥éª¤1ï¼šä¸‹è½½YouTubeè§†é¢‘',
        2: '<i class="fas fa-microphone me-2"></i>æ­¥éª¤2ï¼šè¯­éŸ³è½¬å½•',
        3: '<i class="fas fa-camera me-2"></i>æ­¥éª¤3ï¼šæå–æˆªå›¾',
        4: '<i class="fas fa-file-alt me-2"></i>æ­¥éª¤4ï¼šç”Ÿæˆæ–‡ç« ',
        5: '<i class="fas fa-robot me-2"></i>æ­¥éª¤5ï¼šç”ŸæˆPrompt'
    };
    
    const titleElement = document.getElementById('currentStepTitle');
    if (titleElement && titles[step]) {
        titleElement.innerHTML = titles[step];
    }
}

// æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
function showConfirmation(message) {
    const panel = document.getElementById('confirmationPanel');
    const messageElement = document.getElementById('confirmationMessage');
    
    messageElement.textContent = message;
    panel.style.display = 'block';
}

// éšè—ç¡®è®¤å¯¹è¯æ¡†
function hideConfirmation() {
    document.getElementById('confirmationPanel').style.display = 'none';
}

// æ›´æ–°è¾“å‡ºæ–‡ä»¶åˆ—è¡¨
function updateOutputFiles(step) {
    fetch(`/api/step_status/${projectName}/${step}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayFiles(data.files);
            }
        })
        .catch(error => {
            console.error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
        });
}

// æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
function displayFiles(files) {
    const outputFiles = document.getElementById('outputFiles');
    
    if (files && files.length > 0) {
        let html = '<div class="file-list">';
        
        files.forEach(file => {
            if (file.is_directory) {
                html += `
                    <div class="file-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-folder me-2 text-warning"></i>
                            <strong>${file.name}</strong>
                            <small class="text-muted d-block ms-4">${file.file_count} ä¸ªæ–‡ä»¶</small>
                        </div>
                    </div>
                `;
            } else {
                const size = formatFileSize(file.size);
                const fileExt = file.name.split('.').pop().toLowerCase();
                const isPreviewable = ['md', 'txt', 'json', 'srt', 'log'].includes(fileExt);
                
                html += `
                    <div class="file-item d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <i class="fas fa-file me-2 text-info"></i>
                            <span>${file.name}</span>
                            <small class="text-muted d-block ms-4">${size}</small>
                        </div>
                        <div class="file-actions d-flex gap-1">
                            ${isPreviewable ? `
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="previewFile('${file.name}', '${file.path}')" 
                                        title="é¢„è§ˆ">
                                    <i class="fas fa-eye"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-outline-success" 
                                    onclick="downloadFile('${file.path}')" 
                                    title="ä¸‹è½½">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
        });
        
        html += '</div>';
        outputFiles.innerHTML = html;
    } else {
        outputFiles.innerHTML = '<p class="text-muted text-center">æš‚æ— è¾“å‡ºæ–‡ä»¶</p>';
    }
}

// é¢„è§ˆæ–‡ä»¶
function previewFile(fileName, filePath) {
    showLoading();
    
    // ä½¿ç”¨APIé¢„è§ˆæ–‡ä»¶
    fetch(`/api/file_preview/${projectName}/${currentStep}/${fileName}`)
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data.success) {
                showFilePreviewModal(fileName, data.content);
            } else {
                showAlert(`é¢„è§ˆå¤±è´¥: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            showAlert(`é¢„è§ˆå¤±è´¥: ${error}`, 'danger');
        });
}

// æ˜¾ç¤ºæ–‡ä»¶é¢„è§ˆæ¨¡æ€æ¡†
function showFilePreviewModal(fileName, content) {
    const modal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
    document.getElementById('previewFileName').textContent = fileName;
    document.getElementById('previewContent').textContent = content;
    modal.show();
}

// ä¸‹è½½æ–‡ä»¶
function downloadFile(filePath) {
    window.location.href = filePath;
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// æ§åˆ¶æŒ‰é’®äº‹ä»¶å¤„ç†
document.getElementById('confirmYes').addEventListener('click', function() {
    hideConfirmation();
    addLogEntry('ç”¨æˆ·ç¡®è®¤ç»§ç»­', 'info');
    // è¿™é‡Œå¯ä»¥å‘é€ç»§ç»­å¤„ç†çš„ä¿¡å·
});

document.getElementById('confirmNo').addEventListener('click', function() {
    hideConfirmation();
    addLogEntry('ç”¨æˆ·é€‰æ‹©é‡æ–°å¤„ç†', 'warning');
    // è¿™é‡Œå¯ä»¥å‘é€é‡æ–°å¤„ç†çš„ä¿¡å·
});

// æ—¥å¿—å¢å¼ºåŠŸèƒ½
let autoScroll = true;
let startTime = Date.now();
let timerInterval = null;

// æ—¥å¿—çº§åˆ«ç­›é€‰
document.getElementById('logLevelFilter').addEventListener('change', function() {
    const level = this.value;
    const logEntries = document.querySelectorAll('.log-entry');
    
    logEntries.forEach(entry => {
        if (level === 'all') {
            entry.style.display = '';
        } else {
            entry.style.display = entry.classList.contains(level) ? '' : 'none';
        }
    });
});

// æ—¥å¿—æœç´¢
document.getElementById('logSearch').addEventListener('input', function() {
    const searchText = this.value.toLowerCase();
    const logEntries = document.querySelectorAll('.log-entry');
    
    logEntries.forEach(entry => {
        const text = entry.textContent.toLowerCase();
        if (searchText === '' || text.includes(searchText)) {
            entry.style.display = '';
            // é«˜äº®åŒ¹é…çš„æ–‡æœ¬
            if (searchText !== '') {
                const originalText = entry.textContent;
                const regex = new RegExp(`(${searchText})`, 'gi');
                const highlightedText = originalText.replace(regex, '<mark>$1</mark>');
                entry.innerHTML = highlightedText;
            }
        } else {
            entry.style.display = 'none';
        }
    });
});

// å¤åˆ¶æ—¥å¿—
document.getElementById('copyLogsBtn').addEventListener('click', function() {
    const logOutput = document.getElementById('logOutput');
    const visibleLogs = Array.from(logOutput.querySelectorAll('.log-entry'))
        .filter(entry => entry.style.display !== 'none')
        .map(entry => entry.textContent)
        .join('\n');
    
    navigator.clipboard.writeText(visibleLogs).then(() => {
        showAlert('æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }).catch(err => {
        showAlert('å¤åˆ¶å¤±è´¥: ' + err, 'danger');
    });
});

// å¯¼å‡ºæ—¥å¿—
document.getElementById('exportLogsBtn').addEventListener('click', function() {
    window.location.href = `/api/logs/export/${projectName}`;
});

// æ¸…ç©ºæ—¥å¿—æ˜¾ç¤º
document.getElementById('clearLogsBtn').addEventListener('click', function() {
    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ—¥å¿—æ˜¾ç¤ºå—ï¼Ÿæ­¤æ“ä½œä¸ä¼šåˆ é™¤æœåŠ¡å™¨æ—¥å¿—ã€‚')) {
        const logOutput = document.getElementById('logOutput');
        logOutput.innerHTML = '<div class="log-entry info">æ—¥å¿—å·²æ¸…ç©º</div>';
    }
});

// åˆ‡æ¢è‡ªåŠ¨æ»šåŠ¨
document.getElementById('toggleAutoScrollBtn').addEventListener('click', function() {
    autoScroll = !autoScroll;
    this.classList.toggle('active', autoScroll);
    
    if (autoScroll) {
        const logOutput = document.getElementById('logOutput');
        logOutput.scrollTop = logOutput.scrollHeight;
    }
    
    showAlert(`è‡ªåŠ¨æ»šåŠ¨å·²${autoScroll ? 'å¼€å¯' : 'å…³é—­'}`, 'info');
});

// æ›´æ–°addLogEntryå‡½æ•°ä»¥æ”¯æŒè‡ªåŠ¨æ»šåŠ¨
const originalAddLogEntry = addLogEntry;
addLogEntry = function(message, type = 'info') {
    const logOutput = document.getElementById('logOutput');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry ${type}`;
    logEntry.textContent = `[${timestamp}] ${message}`;
    
    logOutput.appendChild(logEntry);
    
    if (autoScroll) {
        logOutput.scrollTop = logOutput.scrollHeight;
    }
};

// æ—¶é—´è®¡æ—¶å™¨
function startTimer() {
    timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('elapsedTime').textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }, 1000);
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

// æ­¥éª¤æ§åˆ¶ç›¸å…³
document.getElementById('retryFromStepBtn').addEventListener('click', function() {
    const step = document.getElementById('retryFromStep').value;
    
    if (confirm(`ç¡®å®šè¦ä»æ­¥éª¤${step}é‡æ–°å¼€å§‹å—ï¼Ÿ`)) {
        showLoading();
        
        fetch('/api/process/retry_step', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                project_name: projectName,
                step: parseInt(step)
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data.success) {
                showAlert('å·²å¼€å§‹ä»æŒ‡å®šæ­¥éª¤é‡æ–°å¤„ç†', 'success');
                location.reload();
            } else {
                showAlert(`é‡è¯•å¤±è´¥: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            hideLoading();
            showAlert(`é‡è¯•å¤±è´¥: ${error}`, 'danger');
        });
    }
});

// é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹æ¨¡æ‹Ÿå¤„ç†
document.addEventListener('DOMContentLoaded', function() {
    addLogEntry('é¡µé¢åŠ è½½å®Œæˆ', 'success');
    addLogEntry('æ³¨æ„ï¼šå½“å‰ä¸ºæ¼”ç¤ºæ¨¡å¼ï¼Œå®é™…å¤„ç†åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­', 'warning');
    
    // å¯åŠ¨è®¡æ—¶å™¨
    startTimer();
    
    // æ¨¡æ‹Ÿå¤„ç†è¿›åº¦ï¼ˆä»…ç”¨äºæ¼”ç¤ºï¼‰
    setTimeout(() => {
        addLogEntry('å¼€å§‹ä¸‹è½½YouTubeè§†é¢‘...', 'info');
        addLogEntry('è§†é¢‘é“¾æ¥: ' + youtubeUrl, 'info');
    }, 1000);
});
</script>
{% endblock %}
