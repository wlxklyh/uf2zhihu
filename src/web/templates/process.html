{% extends "base.html" %}

{% block title %}处理中 - YouTube转文章工具{% endblock %}

{% block extra_css %}
<style>
.step-progress {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2rem;
}

.step-progress .step {
    flex: 1;
    text-align: center;
    position: relative;
}

.step-progress .step:not(:last-child):after {
    content: '';
    position: absolute;
    top: 20px;
    left: 50%;
    width: 100%;
    height: 2px;
    background: #e9ecef;
    z-index: 1;
}

.step-progress .step.completed:not(:last-child):after {
    background: #28a745;
}

.step-progress .step.active:not(:last-child):after {
    background: linear-gradient(to right, #28a745 50%, #e9ecef 50%);
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e9ecef;
    color: #6c757d;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 0.5rem;
    position: relative;
    z-index: 2;
}

.step.active .step-number {
    background: #007bff;
    color: white;
}

.step.completed .step-number {
    background: #28a745;
    color: white;
}

.step.error .step-number {
    background: #dc3545;
    color: white;
}

.log-output {
    background: #1e1e1e;
    color: #f8f9fa;
    border-radius: 0.375rem;
    padding: 1rem;
    height: 400px;
    overflow-y: auto;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.875rem;
    line-height: 1.4;
}

.log-entry {
    margin-bottom: 0.25rem;
    padding: 0.25rem 0;
}

.log-entry.info { color: #17a2b8; }
.log-entry.success { color: #28a745; }
.log-entry.warning { color: #ffc107; }
.log-entry.error { color: #dc3545; }

.file-list {
    max-height: 300px;
    overflow-y: auto;
}

.file-item {
    padding: 0.5rem;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 0.5rem;
    background: #f8f9fa;
}

.file-item:hover {
    background: #e9ecef;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-0">
                <i class="fas fa-cogs me-2"></i>
                处理进度
            </h2>
            <p class="text-muted">项目：{{ project_name }}</p>
        </div>
    </div>

    <!-- 步骤进度条 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="step-progress">
                        <div class="step active" id="step1">
                            <div class="step-number">1</div>
                            <small>下载视频</small>
                        </div>
                        <div class="step" id="step2">
                            <div class="step-number">2</div>
                            <small>语音转录</small>
                        </div>
                        <div class="step" id="step3">
                            <div class="step-number">3</div>
                            <small>翻译字幕</small>
                        </div>
                        <div class="step" id="step4">
                            <div class="step-number">4</div>
                            <small>提取截图</small>
                        </div>
                        <div class="step" id="step5">
                            <div class="step-number">5</div>
                            <small>生成文章</small>
                        </div>
                        <div class="step" id="step6">
                            <div class="step-number">6</div>
                            <small>生成Prompt</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 主要内容区域 -->
    <div class="row">
        <!-- 左侧：当前步骤详情 -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0" id="currentStepTitle">
                        <i class="fas fa-download me-2"></i>
                        步骤1：下载YouTube视频
                    </h5>
                </div>
                <div class="card-body">
                    <!-- 实时日志输出 -->
                    <div class="log-output" id="logOutput">
                        <div class="log-entry info">正在初始化处理流程...</div>
                        <div class="log-entry info">项目名称: {{ project_name }}</div>
                        <div class="log-entry info">YouTube链接: {{ youtube_url }}</div>
                        <div class="log-entry info">准备开始处理...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧：控制面板和输出文件 -->
        <div class="col-lg-4">
            <!-- 控制面板 -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-gamepad me-2"></i>
                        控制面板
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-warning" id="pauseBtn" disabled>
                            <i class="fas fa-pause me-2"></i>暂停
                        </button>
                        <button class="btn btn-info" id="retryBtn" disabled>
                            <i class="fas fa-redo me-2"></i>重试当前步骤
                        </button>
                        <button class="btn btn-secondary" id="skipBtn" disabled>
                            <i class="fas fa-forward me-2"></i>跳过当前步骤
                        </button>
                    </div>
                    
                    <!-- 人工确认对话框 -->
                    <div id="confirmationPanel" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <strong>需要确认：</strong>
                            <p id="confirmationMessage" class="mb-2"></p>
                            <div class="d-grid gap-2">
                                <button class="btn btn-success btn-sm" id="confirmYes">
                                    <i class="fas fa-check me-1"></i>确认继续
                                </button>
                                <button class="btn btn-danger btn-sm" id="confirmNo">
                                    <i class="fas fa-times me-1"></i>重新处理
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 输出文件预览 -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-folder-open me-2"></i>
                        输出文件
                    </h6>
                </div>
                <div class="card-body" id="outputFiles">
                    <p class="text-muted text-center">处理完成后显示输出文件</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
// 初始化Socket.IO连接
const socket = io();

// 页面加载时获取参数
const urlParams = new URLSearchParams(window.location.search);
const projectName = urlParams.get('project') || '{{ project_name }}';
const youtubeUrl = urlParams.get('url') || '{{ youtube_url }}';

// 当前步骤状态
let currentStep = 1;
let isProcessing = true;

// Socket.IO事件处理
socket.on('connect', function() {
    console.log('已连接到服务器');
    addLogEntry('已连接到服务器', 'success');
    
    // 加入项目房间
    socket.emit('join_project', {project_name: projectName});
});

socket.on('joined_project', function(data) {
    addLogEntry('已加入项目: ' + data.project_name, 'info');
});

socket.on('progress_update', function(data) {
    if (data.project_name === projectName) {
        addLogEntry(data.message, 'info');
        updateStepProgress(data.step, data.progress);
    }
});

socket.on('step_complete', function(data) {
    if (data.project_name === projectName) {
        const status = data.success ? 'success' : 'error';
        addLogEntry(data.message, status);
        
        if (data.success) {
            markStepCompleted(data.step);
            if (data.step < 6) {
                setActiveStep(data.step + 1);
            } else {
                // 所有步骤完成，跳转到结果页面
                setTimeout(() => {
                    window.location.href = `/results/${projectName}`;
                }, 2000);
            }
        } else {
            markStepError(data.step);
            showConfirmation('步骤失败，是否重试？');
        }
        
        // 更新输出文件列表
        updateOutputFiles(data.step);
    }
});

// 添加日志条目
function addLogEntry(message, type = 'info') {
    const logOutput = document.getElementById('logOutput');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry ${type}`;
    logEntry.textContent = `[${timestamp}] ${message}`;
    
    logOutput.appendChild(logEntry);
    logOutput.scrollTop = logOutput.scrollHeight;
}

// 更新步骤进度
function updateStepProgress(step, progress) {
    // 这里可以添加进度条更新逻辑
    console.log(`步骤 ${step} 进度: ${progress}%`);
}

// 设置当前活动步骤
function setActiveStep(step) {
    // 移除所有活动状态
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    
    // 设置新的活动步骤
    const stepElement = document.getElementById(`step${step}`);
    if (stepElement) {
        stepElement.classList.add('active');
        currentStep = step;
        
        // 更新步骤标题
        updateStepTitle(step);
    }
}

// 标记步骤完成
function markStepCompleted(step) {
    const stepElement = document.getElementById(`step${step}`);
    if (stepElement) {
        stepElement.classList.remove('active');
        stepElement.classList.add('completed');
    }
}

// 标记步骤错误
function markStepError(step) {
    const stepElement = document.getElementById(`step${step}`);
    if (stepElement) {
        stepElement.classList.remove('active');
        stepElement.classList.add('error');
    }
}

// 更新步骤标题
function updateStepTitle(step) {
    const titles = {
        1: '<i class="fas fa-download me-2"></i>步骤1：下载YouTube视频',
        2: '<i class="fas fa-microphone me-2"></i>步骤2：语音转录',
        3: '<i class="fas fa-language me-2"></i>步骤3：翻译字幕',
        4: '<i class="fas fa-camera me-2"></i>步骤4：提取截图',
        5: '<i class="fas fa-file-alt me-2"></i>步骤5：生成文章',
        6: '<i class="fas fa-robot me-2"></i>步骤6：生成Prompt'
    };
    
    const titleElement = document.getElementById('currentStepTitle');
    if (titleElement && titles[step]) {
        titleElement.innerHTML = titles[step];
    }
}

// 显示确认对话框
function showConfirmation(message) {
    const panel = document.getElementById('confirmationPanel');
    const messageElement = document.getElementById('confirmationMessage');
    
    messageElement.textContent = message;
    panel.style.display = 'block';
}

// 隐藏确认对话框
function hideConfirmation() {
    document.getElementById('confirmationPanel').style.display = 'none';
}

// 更新输出文件列表
function updateOutputFiles(step) {
    fetch(`/api/step_status/${projectName}/${step}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayFiles(data.files);
            }
        })
        .catch(error => {
            console.error('获取文件列表失败:', error);
        });
}

// 显示文件列表
function displayFiles(files) {
    const outputFiles = document.getElementById('outputFiles');
    
    if (files && files.length > 0) {
        let html = '<div class="file-list">';
        
        files.forEach(file => {
            if (file.is_directory) {
                html += `
                    <div class="file-item">
                        <i class="fas fa-folder me-2 text-warning"></i>
                        <strong>${file.name}</strong>
                        <small class="text-muted d-block">${file.file_count} 个文件</small>
                    </div>
                `;
            } else {
                const size = formatFileSize(file.size);
                html += `
                    <div class="file-item">
                        <i class="fas fa-file me-2 text-info"></i>
                        ${file.name}
                        <small class="text-muted d-block">${size}</small>
                    </div>
                `;
            }
        });
        
        html += '</div>';
        outputFiles.innerHTML = html;
    } else {
        outputFiles.innerHTML = '<p class="text-muted text-center">暂无输出文件</p>';
    }
}

// 格式化文件大小
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// 控制按钮事件处理
document.getElementById('confirmYes').addEventListener('click', function() {
    hideConfirmation();
    addLogEntry('用户确认继续', 'info');
    // 这里可以发送继续处理的信号
});

document.getElementById('confirmNo').addEventListener('click', function() {
    hideConfirmation();
    addLogEntry('用户选择重新处理', 'warning');
    // 这里可以发送重新处理的信号
});

// 页面加载完成后开始模拟处理
document.addEventListener('DOMContentLoaded', function() {
    addLogEntry('页面加载完成', 'success');
    addLogEntry('注意：当前为演示模式，实际处理功能正在开发中', 'warning');
    
    // 模拟处理进度（仅用于演示）
    setTimeout(() => {
        addLogEntry('开始下载YouTube视频...', 'info');
        addLogEntry('视频链接: ' + youtubeUrl, 'info');
    }, 1000);
});
</script>
{% endblock %}
